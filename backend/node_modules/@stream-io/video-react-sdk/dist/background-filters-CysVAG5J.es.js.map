{"version":3,"file":"background-filters-CysVAG5J.es.js","sources":["../../src/components/BackgroundFilters/BackgroundFilters.tsx"],"sourcesContent":["import {\n  Context,\n  PropsWithChildren,\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport { flushSync } from 'react-dom';\nimport { useCall, useCallStateHooks } from '@stream-io/video-react-bindings';\nimport { Call, disposeOfMediaStream } from '@stream-io/video-client';\nimport {\n  BackgroundBlurLevel,\n  createRenderer,\n  isMediaPipePlatformSupported,\n  isPlatformSupported,\n  loadMediaPipe,\n  loadTFLite,\n  PerformanceStats,\n  Renderer,\n  TFLite,\n  VirtualBackground,\n} from '@stream-io/video-filters-web';\nimport clsx from 'clsx';\nimport type {\n  BackgroundFiltersPerformance,\n  BackgroundFiltersProps,\n  BackgroundFiltersContextValue,\n  PerformanceDegradationReason,\n} from './types';\n\n/**\n * Constants for FPS warning calculation.\n * Smooths out quick spikes using an EMA, ignores brief outliers,\n * and uses two thresholds to avoid flickering near the limit.\n */\nconst ALPHA = 0.2;\nconst FPS_WARNING_THRESHOLD_LOWER = 23;\nconst FPS_WARNING_THRESHOLD_UPPER = 25;\nconst DEFAULT_FPS = 30;\nconst DEVIATION_LIMIT = 0.5;\nconst OUTLIER_PERSISTENCE = 5;\n\n/**\n * Represents the available background filter processing engines.\n */\nenum FilterEngine {\n  TF,\n  MEDIA_PIPE,\n  NONE,\n}\n\n/**\n * Determines which filter engine is available.\n * MEDIA_PIPE is the default unless legacy filters are requested or MediaPipe is unsupported.\n *\n * Returns NONE if neither is supported.\n */\nconst determineEngine = async (\n  useLegacyFilter: boolean | undefined,\n  forceSafariSupport: boolean | undefined,\n  forceMobileSupport: boolean | undefined,\n): Promise<FilterEngine> => {\n  if (useLegacyFilter) {\n    const isTfPlatformSupported = await isPlatformSupported({\n      forceSafariSupport,\n      forceMobileSupport,\n    });\n    return isTfPlatformSupported ? FilterEngine.TF : FilterEngine.NONE;\n  }\n\n  const isMediaPipeSupported = await isMediaPipePlatformSupported({\n    forceSafariSupport,\n    forceMobileSupport,\n  });\n\n  return isMediaPipeSupported ? FilterEngine.MEDIA_PIPE : FilterEngine.NONE;\n};\n\n/**\n * A provider component that enables the use of background filters in your app.\n *\n * Please make sure you have the `@stream-io/video-filters-web` package installed\n * in your project before using this component.\n */\nexport const BackgroundFiltersProvider = (\n  props: PropsWithChildren<BackgroundFiltersProps> & {\n    // for code splitting. Prevents circular dependency issues where\n    // this Context needs to be present in the main chunk, but also\n    // imported by the background filters chunk.\n    ContextProvider: Context<BackgroundFiltersContextValue | undefined>;\n  },\n) => {\n  const {\n    ContextProvider,\n    children,\n    backgroundImages = [],\n    backgroundFilter: bgFilterFromProps = undefined,\n    backgroundImage: bgImageFromProps = undefined,\n    backgroundBlurLevel: bgBlurLevelFromProps = undefined,\n    tfFilePath,\n    modelFilePath,\n    useLegacyFilter,\n    basePath,\n    onError,\n    performanceThresholds,\n    forceSafariSupport,\n    forceMobileSupport,\n  } = props;\n\n  const call = useCall();\n  const { useCallStatsReport } = useCallStateHooks();\n  const callStatsReport = useCallStatsReport();\n\n  const [backgroundFilter, setBackgroundFilter] = useState(bgFilterFromProps);\n  const [backgroundImage, setBackgroundImage] = useState(bgImageFromProps);\n  const [backgroundBlurLevel, setBackgroundBlurLevel] =\n    useState(bgBlurLevelFromProps);\n\n  const [showLowFpsWarning, setShowLowFpsWarning] = useState<boolean>(false);\n  const [isLoading, setIsLoading] = useState<boolean>(false);\n\n  const fpsWarningThresholdLower =\n    performanceThresholds?.fpsWarningThresholdLower ??\n    FPS_WARNING_THRESHOLD_LOWER;\n  const fpsWarningThresholdUpper =\n    performanceThresholds?.fpsWarningThresholdUpper ??\n    FPS_WARNING_THRESHOLD_UPPER;\n  const defaultFps = performanceThresholds?.defaultFps ?? DEFAULT_FPS;\n\n  const emaRef = useRef<number>(defaultFps);\n  const outlierStreakRef = useRef<number>(0);\n\n  const handleStats = useCallback(\n    (stats: PerformanceStats) => {\n      const fps = stats?.fps;\n      if (fps === undefined || fps === null) {\n        emaRef.current = defaultFps;\n        outlierStreakRef.current = 0;\n        setShowLowFpsWarning(false);\n        return;\n      }\n\n      const prevEma = emaRef.current;\n      const deviation = Math.abs(fps - prevEma) / prevEma;\n\n      const isOutlier = fps < prevEma && deviation > DEVIATION_LIMIT;\n      outlierStreakRef.current = isOutlier ? outlierStreakRef.current + 1 : 0;\n      if (isOutlier && outlierStreakRef.current < OUTLIER_PERSISTENCE) return;\n\n      emaRef.current = ALPHA * fps + (1 - ALPHA) * prevEma;\n\n      setShowLowFpsWarning((prev) => {\n        if (prev && emaRef.current > fpsWarningThresholdUpper) return false;\n        if (!prev && emaRef.current < fpsWarningThresholdLower) return true;\n\n        return prev;\n      });\n    },\n    [fpsWarningThresholdLower, fpsWarningThresholdUpper, defaultFps],\n  );\n\n  const performance: BackgroundFiltersPerformance = useMemo(() => {\n    if (!backgroundFilter) {\n      return { degraded: false };\n    }\n\n    const reasons: Array<PerformanceDegradationReason> = [];\n\n    if (showLowFpsWarning) {\n      reasons.push('frame-drop');\n    }\n\n    const qualityLimitationReasons =\n      callStatsReport?.publisherStats?.qualityLimitationReasons;\n\n    if (\n      showLowFpsWarning &&\n      qualityLimitationReasons &&\n      qualityLimitationReasons?.includes('cpu')\n    ) {\n      reasons.push('cpu-throttling');\n    }\n\n    return {\n      degraded: reasons.length > 0,\n      reason: reasons.length > 0 ? reasons : undefined,\n    };\n  }, [\n    showLowFpsWarning,\n    callStatsReport?.publisherStats?.qualityLimitationReasons,\n    backgroundFilter,\n  ]);\n\n  const prevDegradedRef = useRef<boolean | undefined>(undefined);\n  useEffect(() => {\n    const currentDegraded = performance.degraded;\n    const prevDegraded = prevDegradedRef.current;\n\n    if (\n      !!backgroundFilter &&\n      prevDegraded !== undefined &&\n      prevDegraded !== currentDegraded\n    ) {\n      call?.tracer.trace('backgroundFilters.performance', {\n        degraded: currentDegraded,\n        reason: performance?.reason,\n        fps: emaRef.current,\n      });\n    }\n    prevDegradedRef.current = currentDegraded;\n  }, [\n    performanceThresholds,\n    performance.degraded,\n    performance.reason,\n    backgroundFilter,\n    call?.tracer,\n  ]);\n\n  const applyBackgroundImageFilter = useCallback((imageUrl: string) => {\n    setBackgroundFilter('image');\n    setBackgroundImage(imageUrl);\n  }, []);\n\n  const applyBackgroundBlurFilter = useCallback(\n    (blurLevel: BackgroundBlurLevel = 'high') => {\n      setBackgroundFilter('blur');\n      setBackgroundBlurLevel(blurLevel);\n    },\n    [],\n  );\n\n  const disableBackgroundFilter = useCallback(() => {\n    setBackgroundFilter(undefined);\n    setBackgroundImage(undefined);\n    setBackgroundBlurLevel(undefined);\n\n    emaRef.current = defaultFps;\n    outlierStreakRef.current = 0;\n    setShowLowFpsWarning(false);\n  }, [defaultFps]);\n\n  const [engine, setEngine] = useState<FilterEngine>(FilterEngine.NONE);\n  const [isSupported, setIsSupported] = useState(false);\n  useEffect(() => {\n    determineEngine(\n      useLegacyFilter,\n      forceSafariSupport,\n      forceMobileSupport,\n    ).then((determinedEngine) => {\n      setEngine(determinedEngine);\n      setIsSupported(determinedEngine !== FilterEngine.NONE);\n    });\n  }, [forceMobileSupport, forceSafariSupport, useLegacyFilter]);\n\n  const [tfLite, setTfLite] = useState<TFLite>();\n  useEffect(() => {\n    if (engine !== FilterEngine.TF) return;\n\n    loadTFLite({ basePath, modelFilePath, tfFilePath })\n      .then(setTfLite)\n      .catch((err) => console.error('Failed to load TFLite', err));\n  }, [basePath, engine, modelFilePath, tfFilePath]);\n\n  const [mediaPipe, setMediaPipe] = useState<ArrayBuffer>();\n  useEffect(() => {\n    if (engine !== FilterEngine.MEDIA_PIPE) return;\n\n    loadMediaPipe({\n      basePath: basePath,\n      modelPath: modelFilePath,\n    })\n      .then(setMediaPipe)\n      .catch((err) => console.error('Failed to preload MediaPipe', err));\n  }, [engine, modelFilePath, basePath]);\n\n  const handleError = useCallback(\n    (error: any) => {\n      console.warn(\n        '[filters] Filter encountered an error and will be disabled',\n      );\n      disableBackgroundFilter();\n      onError?.(error);\n    },\n    [disableBackgroundFilter, onError],\n  );\n\n  const isReady = useLegacyFilter ? !!tfLite : !!mediaPipe;\n  const contextValue: BackgroundFiltersContextValue = {\n    isSupported,\n    performance,\n    isReady,\n    isLoading,\n    backgroundImage,\n    backgroundBlurLevel,\n    backgroundFilter,\n    disableBackgroundFilter,\n    applyBackgroundBlurFilter,\n    applyBackgroundImageFilter,\n    backgroundImages,\n    tfFilePath,\n    modelFilePath,\n    basePath,\n    onError: handleError,\n  };\n  return (\n    <ContextProvider.Provider value={contextValue}>\n      {children}\n      {isReady && (\n        <BackgroundFilters\n          api={contextValue}\n          tfLite={tfLite}\n          engine={engine}\n          onStats={handleStats}\n          setIsLoading={setIsLoading}\n        />\n      )}\n    </ContextProvider.Provider>\n  );\n};\n\nconst BackgroundFilters = (props: {\n  api: BackgroundFiltersContextValue;\n  tfLite?: TFLite;\n  engine: FilterEngine;\n  onStats: (stats: PerformanceStats) => void;\n  setIsLoading: (loading: boolean) => void;\n}) => {\n  const call = useCall();\n  const { engine, api, tfLite, onStats, setIsLoading } = props;\n  const { children, start } = useRenderer(api, tfLite, call, engine);\n  const { onError, backgroundFilter } = api;\n  const handleErrorRef = useRef<((error: any) => void) | undefined>(undefined);\n  handleErrorRef.current = onError;\n\n  const handleStatsRef = useRef<\n    ((stats: PerformanceStats) => void) | undefined\n  >(undefined);\n  handleStatsRef.current = onStats;\n\n  useEffect(() => {\n    if (!call || !backgroundFilter) return;\n\n    setIsLoading(true);\n    const { unregister, registered } = call.camera.registerFilter((ms) => {\n      return start(\n        ms,\n        (error) => handleErrorRef.current?.(error),\n        (stats: PerformanceStats) => handleStatsRef.current?.(stats),\n      );\n    });\n    registered.finally(() => {\n      setIsLoading(false);\n    });\n\n    return () => {\n      unregister().catch((err) => console.warn(`Can't unregister filter`, err));\n    };\n  }, [call, start, backgroundFilter, setIsLoading]);\n\n  return children;\n};\n\nconst useRenderer = (\n  api: BackgroundFiltersContextValue,\n  tfLite: TFLite | undefined,\n  call: Call | undefined,\n  engine: FilterEngine,\n) => {\n  const {\n    backgroundFilter,\n    backgroundBlurLevel,\n    backgroundImage,\n    modelFilePath,\n    basePath,\n  } = api;\n\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const bgImageRef = useRef<HTMLImageElement>(null);\n  const [videoSize, setVideoSize] = useState<{ width: number; height: number }>(\n    {\n      width: 1920,\n      height: 1080,\n    },\n  );\n\n  const start = useCallback(\n    (\n      ms: MediaStream,\n      onError?: (error: any) => void,\n      onStats?: (stats: PerformanceStats) => void,\n    ) => {\n      let outputStream: MediaStream | undefined;\n      let processor: VirtualBackground | undefined;\n      let renderer: Renderer | undefined;\n\n      const output = new Promise<MediaStream>((resolve, reject) => {\n        if (!backgroundFilter) {\n          reject(new Error('No filter specified'));\n          return;\n        }\n\n        const videoEl = videoRef.current;\n        const canvasEl = canvasRef.current;\n        const bgImageEl = bgImageRef.current;\n\n        const [track] = ms.getVideoTracks();\n\n        if (!track) {\n          reject(new Error('No video tracks in input media stream'));\n          return;\n        }\n\n        if (engine === FilterEngine.MEDIA_PIPE) {\n          call?.tracer.trace('backgroundFilters.enable', {\n            backgroundFilter,\n            backgroundBlurLevel,\n            backgroundImage,\n            engine,\n          });\n\n          if (!videoEl) {\n            reject(new Error('Renderer started before elements are ready'));\n            return;\n          }\n\n          const trackSettings = track.getSettings();\n          flushSync(() =>\n            setVideoSize({\n              width: trackSettings.width ?? 0,\n              height: trackSettings.height ?? 0,\n            }),\n          );\n\n          processor = new VirtualBackground(\n            track,\n            {\n              basePath: basePath,\n              modelPath: modelFilePath,\n              backgroundBlurLevel,\n              backgroundImage,\n              backgroundFilter,\n            },\n            { onError, onStats },\n          );\n          processor\n            .start()\n            .then((processedTrack) => {\n              outputStream = new MediaStream([processedTrack]);\n              resolve(outputStream);\n            })\n            .catch((error) => {\n              reject(error);\n            });\n\n          return;\n        }\n\n        if (engine === FilterEngine.TF) {\n          if (!videoEl || !canvasEl || (backgroundImage && !bgImageEl)) {\n            reject(new Error('Renderer started before elements are ready'));\n            return;\n          }\n\n          videoEl.srcObject = ms;\n          videoEl.play().then(\n            () => {\n              const trackSettings = track.getSettings();\n              flushSync(() =>\n                setVideoSize({\n                  width: trackSettings.width ?? 0,\n                  height: trackSettings.height ?? 0,\n                }),\n              );\n              call?.tracer.trace('backgroundFilters.enable', {\n                backgroundFilter,\n                backgroundBlurLevel,\n                backgroundImage,\n                engine,\n              });\n\n              if (!tfLite) {\n                reject(new Error('TensorFlow Lite not loaded'));\n                return;\n              }\n\n              renderer = createRenderer(\n                tfLite,\n                videoEl,\n                canvasEl,\n                {\n                  backgroundFilter,\n                  backgroundBlurLevel,\n                  backgroundImage: bgImageEl ?? undefined,\n                },\n                onError,\n              );\n              outputStream = canvasEl.captureStream();\n\n              resolve(outputStream);\n            },\n            () => {\n              reject(new Error('Could not play the source video stream'));\n            },\n          );\n          return;\n        }\n\n        reject(new Error('No supported engine available'));\n      });\n\n      return {\n        output,\n        stop: () => {\n          call?.tracer.trace('backgroundFilters.disable', null);\n          processor?.stop();\n          renderer?.dispose();\n          if (videoRef.current) videoRef.current.srcObject = null;\n          if (outputStream) disposeOfMediaStream(outputStream);\n        },\n      };\n    },\n    [\n      backgroundBlurLevel,\n      backgroundFilter,\n      backgroundImage,\n      call?.tracer,\n      tfLite,\n      engine,\n      modelFilePath,\n      basePath,\n    ],\n  );\n\n  const children = (\n    <div className=\"str-video__background-filters\">\n      <video\n        className={clsx(\n          'str-video__background-filters__video',\n          videoSize.height > videoSize.width &&\n            'str-video__background-filters__video--tall',\n        )}\n        ref={videoRef}\n        playsInline\n        muted\n        controls={false}\n        {...videoSize}\n      />\n      {backgroundImage && (\n        <img\n          className=\"str-video__background-filters__background-image\"\n          alt=\"Background\"\n          ref={bgImageRef}\n          crossOrigin=\"anonymous\"\n          src={backgroundImage}\n          {...videoSize}\n        />\n      )}\n      <canvas\n        className=\"str-video__background-filters__target-canvas\"\n        {...videoSize}\n        ref={canvasRef}\n      />\n    </div>\n  );\n\n  return { start, children };\n};\n"],"names":["_jsxs","_jsx"],"mappings":"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"}